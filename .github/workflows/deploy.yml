name: Deploy to Production Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Application
    runs-on: self-hosted
    timeout-minutes: 30
    
    env:
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
      SECRET: ${{ secrets.SECRET }}
      MERCADOPAGO_ACCESS_TOKEN: ${{ secrets.MERCADOPAGO_ACCESS_TOKEN }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Verificar tÃºnel Cloudflare (sin sudo)
      run: |
        echo "ğŸ” Verificando tÃºnel Cloudflare..."
        
        # Verificar procesos cloudflared
        if pgrep -f "cloudflared tunnel" > /dev/null; then
          echo "âœ… Proceso cloudflared estÃ¡ ejecutÃ¡ndose"
        else
          echo "âš ï¸ No se encontrÃ³ proceso cloudflared activo"
        fi
        
        # Verificar conectividad del dominio
        echo "ğŸŒ Probando conectividad del dominio..."
        if curl -s --max-time 15 -I https://ecomerce.noaservice.org | grep -q "200\|301\|302"; then
          echo "âœ… Dominio responde correctamente"
        else
          echo "âš ï¸ El dominio no responde, pero continuamos el despliegue"
        fi
        
        echo "ğŸ“‹ InformaciÃ³n del sistema:"
        echo "Usuario: $(whoami)"
        pgrep -fl cloudflared || echo "No hay procesos cloudflared visibles"

    - name: Crear archivo .env.production
      run: |
        echo "ğŸ“ Creando .env.production..."
        cd modern-shopp
        
        cat > .env.production << EOF
        NODE_ENV=production
        DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD:-postgres}@postgres:5432/ecommerce
        NEXTAUTH_URL=https://ecomerce.noaservice.org
        NEXTAUTH_SECRET=${NEXTAUTH_SECRET:-MISECRETO}
        SECRET=${SECRET:-MISECRETO}
        MERCADOPAGO_ACCESS_TOKEN=${MERCADOPAGO_ACCESS_TOKEN:-APP_USR-3904014073520705-081821-ac9642583a0c52da7c3d6aae0fa8eafe-2631277847}
        NEXT_PUBLIC_URL=https://ecomerce.noaservice.org
        POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
        EOF
        
        echo "âœ… Archivo .env.production creado"

    - name: Parar servicios existentes
      run: |
        echo "â¹ï¸ Parando contenedores existentes..."
        cd modern-shopp
        docker-compose -f docker-compose.prod.yml down 2>/dev/null || true
        
        echo "ğŸ§¹ Limpiando Docker..."
        docker system prune -af
        docker builder prune -af

    - name: Construir y desplegar aplicaciÃ³n
      run: |
        echo "ğŸ—ï¸ Iniciando construcciÃ³n y despliegue..."
        cd modern-shopp
        
        # Descargar imÃ¡genes base
        echo "ğŸ“¥ Descargando imÃ¡genes base..."
        docker pull postgres:15-alpine
        
        # Construir aplicaciÃ³n sin cache
        echo "ğŸ”¨ Construyendo aplicaciÃ³n..."
        docker-compose -f docker-compose.prod.yml build --no-cache --pull
        
        # Levantar servicios
        echo "ğŸš€ Levantando servicios..."
        docker-compose -f docker-compose.prod.yml up -d
        
        echo "âœ… Despliegue completado!"

    - name: Verificar estado del despliegue
      run: |
        echo "ğŸ“Š Verificando estado de contenedores..."
        cd modern-shopp
        
        # Esperar un poco para que se inicien
        sleep 30
        
        # Mostrar estado de contenedores
        docker-compose -f docker-compose.prod.yml ps
        
        # Verificar estado del tÃºnel systemd
        echo "ğŸ” Verificando estado del tÃºnel Cloudflare..."
        # Verificar estado del tÃºnel systemd
        echo "ğŸ” Verificando estado del tÃºnel Cloudflare..."
        sudo systemctl status cloudflared --no-pager -l
        
        # Verificar conectividad local
        echo "ğŸŒ Verificando conectividad local..."
        curl -f http://localhost:8081/health || echo "âš ï¸ AplicaciÃ³n no responde localmente"
        
        # Verificar conectividad pÃºblica
        echo "ğŸŒ Verificando conectividad pÃºblica..."
        curl -f https://ecomerce.noaservice.org/health || echo "âš ï¸ AplicaciÃ³n no responde pÃºblicamente"
        
        echo "âœ… VerificaciÃ³n completada"

    - name: Mostrar informaciÃ³n de despliegue
      run: |
        echo "ğŸ‰ Despliegue completado exitosamente!"
        echo ""
        echo "ï¿½ InformaciÃ³n del despliegue:"
        echo "  ğŸŒ URL pÃºblica: https://ecomerce.noaservice.org"
        echo "  ğŸ³ Contenedores activos:"
        cd modern-shopp
        docker-compose -f docker-compose.prod.yml ps --format table
        echo ""
        echo "ğŸ“Š Para monitorear:"
        echo "  Ver logs: docker-compose -f docker-compose.prod.yml logs -f"
        echo "  Estado: docker-compose -f docker-compose.prod.yml ps"