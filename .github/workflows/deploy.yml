name: ğŸš€ Deploy to Production Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: ğŸ”„ Deploy Application
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ğŸ“‚ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸš€ Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.PORT }}
        timeout: 600s
        script: |
          echo "ğŸ”„ Iniciando despliegue en $(date)"
          
          # Ir al directorio del proyecto
          cd ${{ secrets.PROJECT_PATH }}/Next-modern-shop/modern-shopp
          
          # Actualizar cÃ³digo
          echo "ğŸ“¥ Actualizando cÃ³digo..."
          git fetch origin main
          git reset --hard origin/main
          
          # Crear .env si no existe
          if [ ! -f ".env" ]; then
            echo "ğŸ“ Creando .env..."
            cat > .env << 'EOF'
          NODE_ENV=production
          DATABASE_URL=postgresql://postgres:postgres_secure_2024@postgres:5432/ecommerce
          NEXTAUTH_URL=http://186.12.205.69:3000
          NEXTAUTH_SECRET=mi_secreto_super_seguro_2024
          SECRET=mi_secreto_super_seguro_2024
          MERCADOPAGO_ACCESS_TOKEN=APP_USR-3904014073520705-081821-ac9642583a0c52da7c3d6aae0fa8eafe-2631277847
          NEXT_PUBLIC_URL=http://186.12.205.69:3000
          POSTGRES_PASSWORD=postgres_secure_2024
          EOF
          fi
          
          # Parar contenedores
          echo "â¹ï¸ Parando contenedores..."
          docker-compose -f docker-compose.prod.yml down 2>/dev/null || docker-compose -f docker-compose.yml down 2>/dev/null || true
          
          # Limpiar Docker
          echo "ğŸ§¹ Limpiando Docker..."
          docker system prune -f
          
          # Levantar contenedores
          echo "ğŸš€ Levantando contenedores..."
          if [ -f "docker-compose.prod.yml" ]; then
            docker-compose -f docker-compose.prod.yml up -d --build
          else
            docker-compose -f docker-compose.yml up -d --build
          fi
          
          echo "âœ… Despliegue completado!"
          echo "ğŸŒ App disponible en: http://186.12.205.69:3000"
    
    - name: ğŸ“Š Get deployment info
      if: success()
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.PORT }}
        script: |
          cd ${{ secrets.PROJECT_PATH }}/Next-modern-shop/modern-shopp
          echo "ğŸ“Š Estado final del despliegue:"
          echo "ğŸ³ Contenedores:"
          docker-compose -f docker-compose.prod.yml ps 2>/dev/null || docker-compose -f docker-compose.yml ps
          echo ""
          echo "ğŸ“ Ãšltimo commit:"
          git log -1 --oneline
          echo ""
          echo "ğŸŒ AplicaciÃ³n disponible en: http://186.12.205.69:3000"