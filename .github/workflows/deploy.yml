name: ğŸš€ Deploy to Production Server

# Se ejecuta cuando haces push a main o manualmente
on:
  push:
    branches: [ main ]
    paths:
      - 'modern-shopp/**'
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '*.md'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Forzar despliegue completo'
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    name: ğŸ”„ Deploy Application
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸ“‚ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸš€ Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.PORT }}
        timeout: 300s
        script: |
          set -e
          
          echo "ğŸ”„ Iniciando despliegue en $(date)"
          
          # Variables
          PROJECT_DIR="${{ secrets.PROJECT_PATH }}/Next-modern-shop/modern-shopp"
          BACKUP_DIR="/tmp/backup-$(date +%Y%m%d-%H%M%S)"
          
          # Ir al directorio del proyecto
          cd $PROJECT_DIR
          
          # Backup de la versiÃ³n actual
          echo "ğŸ“¦ Creando backup..."
          mkdir -p $BACKUP_DIR
          docker-compose -f docker-compose.prod.yml ps > $BACKUP_DIR/containers_status.txt 2>/dev/null || true
          
          # Obtener informaciÃ³n del commit actual antes de actualizar
          CURRENT_COMMIT=$(git rev-parse HEAD)
          echo "ğŸ“ Commit actual: $CURRENT_COMMIT"
          
          # Actualizar cÃ³digo
          echo "ğŸ“¥ Actualizando cÃ³digo desde GitHub..."
          git fetch origin main
          git reset --hard origin/main
          
          # Verificar que hay cambios
          NEW_COMMIT=$(git rev-parse HEAD)
          echo "ğŸ“ Nuevo commit: $NEW_COMMIT"
          
          if [ "$CURRENT_COMMIT" = "$NEW_COMMIT" ] && [ "${{ github.event.inputs.force_deploy }}" != "true" ]; then
            echo "â„¹ï¸  No hay cambios nuevos, saltando despliegue"
            exit 0
          fi
          
          # Crear .env si no existe
          if [ ! -f ".env" ]; then
            echo "ğŸ“ Creando archivo .env..."
            cat > .env << EOF
          NODE_ENV=production
          DATABASE_URL=postgresql://postgres:postgres_secure_2024@postgres:5432/ecommerce
          NEXTAUTH_URL=http://186.12.205.69:3000
          NEXTAUTH_SECRET=$(openssl rand -base64 32)
          SECRET=$(openssl rand -base64 32)
          MERCADOPAGO_ACCESS_TOKEN=APP_USR-3904014073520705-081821-ac9642583a0c52da7c3d6aae0fa8eafe-2631277847
          NEXT_PUBLIC_URL=http://186.12.205.69:3000
          POSTGRES_PASSWORD=postgres_secure_2024
          EOF
          fi
          
          # Parar contenedores actuales
          echo "â¹ï¸  Deteniendo contenedores actuales..."
          docker-compose -f docker-compose.prod.yml down || docker-compose -f docker-compose.yml down || true
          
          # Limpiar recursos no utilizados
          echo "ğŸ§¹ Limpiando recursos Docker..."
          docker system prune -f
          
          # Construir y levantar nuevos contenedores
          echo "ğŸ—ï¸  Construyendo y levantando contenedores..."
          if [ -f "docker-compose.prod.yml" ]; then
            COMPOSE_FILE="docker-compose.prod.yml"
          else
            COMPOSE_FILE="docker-compose.yml"
          fi
          
          docker-compose -f $COMPOSE_FILE up -d --build
          
          # Esperar a que los servicios estÃ©n listos
          echo "â³ Esperando a que los servicios estÃ©n listos..."
          sleep 30
          
          # Verificar que los contenedores estÃ¡n corriendo
          if docker-compose -f $COMPOSE_FILE ps | grep -q "Up"; then
            echo "âœ… Contenedores corriendo correctamente"
            
            # Verificar que la aplicaciÃ³n responde
            echo "ğŸ” Verificando que la aplicaciÃ³n responde..."
            for i in {1..5}; do
              if curl -f http://localhost:3000 > /dev/null 2>&1; then
                echo "âœ… AplicaciÃ³n respondiendo correctamente"
                break
              else
                echo "â³ Intento $i/5: Esperando respuesta de la aplicaciÃ³n..."
                sleep 10
              fi
            done
            
            # Limpiar backup si todo estÃ¡ bien
            rm -rf $BACKUP_DIR
            echo "ğŸ‰ Despliegue completado exitosamente en $(date)"
            echo "ğŸ“Š VersiÃ³n desplegada: $NEW_COMMIT"
            
          else
            echo "âŒ Error: Los contenedores no estÃ¡n corriendo"
            echo "ğŸ”„ Intentando rollback..."
            
            # Rollback al commit anterior
            git reset --hard $CURRENT_COMMIT
            docker-compose -f $COMPOSE_FILE up -d --build
            
            echo "âš ï¸  Rollback completado, versiÃ³n anterior restaurada"
            exit 1
          fi
    
    - name: ğŸ“Š Get deployment info
      if: success()
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: ${{ secrets.PORT }}
        script: |
          cd ${{ secrets.PROJECT_PATH }}/Next-modern-shop/modern-shopp
          echo "ğŸ“Š Estado final del despliegue:"
          echo "ğŸ³ Contenedores:"
          docker-compose -f docker-compose.prod.yml ps 2>/dev/null || docker-compose -f docker-compose.yml ps
          echo ""
          echo "ğŸ“ Ãšltimo commit:"
          git log -1 --oneline
          echo ""
          echo "ğŸŒ AplicaciÃ³n disponible en: http://186.12.205.69:3000"