name: Deploy to Production Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Application
    runs-on: self-hosted
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy application locally
      run: |
        echo "ğŸš€ Iniciando despliegue local en $(date)"
        cd /home/psiconervio/ecomerce/Next-modern-shop/modern-shopp
        
        # Crear .env si no existe
        if [ ! -f ".env" ]; then
          echo "ğŸ“ Creando .env..."
          cat > .env << 'EOF'
        NODE_ENV=production
        DATABASE_URL=postgresql://postgres:postgres_secure_2024@postgres:5432/ecommerce
        NEXTAUTH_URL=https://tu-dominio-cloudflare.com
        NEXTAUTH_SECRET=mi_secreto_super_seguro_2024
        SECRET=mi_secreto_super_seguro_2024
        MERCADOPAGO_ACCESS_TOKEN=APP_USR-3904014073520705-081821-ac9642583a0c52da7c3d6aae0fa8eafe-2631277847
        NEXT_PUBLIC_URL=https://tu-dominio-cloudflare.com
        POSTGRES_PASSWORD=postgres_secure_2024
        EOF
        fi
        
        # Parar contenedores existentes
        echo "â¹ï¸ Parando contenedores..."
        docker-compose -f docker-compose.prod.yml down 2>/dev/null || true
        
        # Limpiar Docker
        echo "ğŸ§¹ Limpiando Docker..."
        docker system prune -f
        
        # Levantar contenedores
        echo "ğŸ—ï¸ Construyendo y levantando..."
        docker-compose -f docker-compose.prod.yml up -d --build
        
        echo "âœ… Despliegue completado!"
        echo "ğŸ“Š Estado de contenedores:"
        docker-compose -f docker-compose.prod.yml ps