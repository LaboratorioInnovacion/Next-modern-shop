name: Deploy to Production Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Application
    runs-on: self-hosted
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Mostrar contenido de deploy.yml y Dockerfile
      run: |
        echo "Contenido actual de .github/workflows/deploy.yml:"
        cat .github/workflows/deploy.yml
        echo "---"
        echo "Contenido actual de Dockerfile usado para el build:"
        cat modern-shopp/Dockerfile

    - name: Listar archivos y carpetas antes del build
      run: |
        echo "Contenido de modern-shopp antes del build:"
        cd modern-shopp
        ls -l
        echo "Contenido de prisma:"
        ls -l prisma || echo "No existe carpeta prisma"
    
    - name: Verificar versiÃ³n de Node en Dockerfile
      run: |
        echo "Dockerfile base (deberÃ­a ser node:20-alpine):"
        grep FROM modern-shopp/Dockerfile || true
        echo "---"
        echo "ğŸš€ Iniciando despliegue local en $(date)"
        cd modern-shopp

        # Crear .env si no existe
        if [ ! -f ".env" ]; then
          echo "ğŸ“ Creando .env..."
          cat > .env << 'EOF'
        NODE_ENV=production
        DATABASE_URL=postgresql://postgres:postgres@postgres:5432/ecommerce
        NEXTAUTH_URL=https://ecomerce.noaservice.org
        NEXTAUTH_SECRET=MISECRETO
        SECRET=MISECRETO
        MERCADOPAGO_ACCESS_TOKEN=APP_USR-3904014073520705-081821-ac9642583a0c52da7c3d6aae0fa8eafe-2631277847
        NEXT_PUBLIC_URL=https://ecomerce.noaservice.org
        POSTGRES_PASSWORD=postgres
        EOF
        fi

        # Parar contenedores existentes
        echo "â¹ï¸ Parando contenedores..."
        docker-compose -f docker-compose.prod.yml down 2>/dev/null || true

        # Limpiar Docker completamente
        echo "ğŸ§¹ Limpiando Docker y cache..."
        docker system prune -af
        docker builder prune -af

        # Pre-descargar imagen de PostgreSQL
        echo "ğŸ“¥ Descargando imagen de PostgreSQL..."
        docker pull postgres:15-alpine

        # Levantar contenedores SIN CACHE
        echo "ğŸ—ï¸ Construyendo desde cero (sin cache)..."
        docker-compose -f docker-compose.prod.yml build --no-cache --pull

        echo "ğŸš€ Levantando contenedores..."
        docker-compose -f docker-compose.prod.yml up -d

        echo "âœ… Despliegue completado!"
        echo "ğŸ“Š Estado de contenedores:"
        docker-compose -f docker-compose.prod.yml ps