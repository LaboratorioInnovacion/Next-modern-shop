name: Deploy Scraper Branch

on:
  push:
    branches: [ feature/scraper ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-and-deploy:
    name: Test & Deploy Scraper
    runs-on: self-hosted
    timeout-minutes: 30
    
    env:
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
      SECRET: ${{ secrets.SECRET }}
      MERCADOPAGO_ACCESS_TOKEN: ${{ secrets.MERCADOPAGO_ACCESS_TOKEN }}
      DROPPERS_EMAIL: ${{ secrets.DROPPERS_EMAIL }}
      DROPPERS_PASSWORD: ${{ secrets.DROPPERS_PASSWORD }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Verificar tÃºnel Cloudflare
      run: |
        echo "ğŸ” Verificando tÃºnel Cloudflare..."
        
        if pgrep -f "cloudflared tunnel" > /dev/null; then
          echo "âœ… Proceso cloudflared estÃ¡ ejecutÃ¡ndose"
        else
          echo "âš ï¸ No se encontrÃ³ proceso cloudflared activo"
        fi
        
        if curl -s --max-time 15 -I https://ecomerce.noaservice.org | grep -q "200\|301\|302"; then
          echo "âœ… Dominio responde correctamente"
        else
          echo "âš ï¸ El dominio no responde, pero continuamos el despliegue"
        fi

    - name: Crear archivo .env.production
      run: |
        echo "ğŸ“ Creando .env.production..."
        cd modern-shopp
        
        cat > .env.production << EOF
        NODE_ENV=production
        DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD:-postgres}@postgres:5432/ecommerce
        NEXTAUTH_URL=https://ecomerce.noaservice.org
        NEXTAUTH_SECRET=${NEXTAUTH_SECRET:-MISECRETO}
        SECRET=${SECRET:-MISECRETO}
        MERCADOPAGO_ACCESS_TOKEN=${MERCADOPAGO_ACCESS_TOKEN}
        NEXT_PUBLIC_URL=https://ecomerce.noaservice.org
        POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
        PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser
        DROPPERS_EMAIL=${DROPPERS_EMAIL}
        DROPPERS_PASSWORD=${DROPPERS_PASSWORD}
        MAX_PAGES=2
        HEADLESS=true
        EOF
        
        echo "âœ… Archivo .env.production creado"

    - name: Parar servicios existentes
      run: |
        echo "â¹ï¸ Parando contenedores existentes..."
        cd modern-shopp
        docker-compose -f docker-compose.prod.yml down 2>/dev/null || true
        
        echo "ğŸ§¹ Limpiando Docker..."
        docker system prune -af --volumes
        docker builder prune -af
        docker image prune -af
        
        echo "ğŸ”„ Reiniciando Docker daemon..."
        sudo systemctl restart docker 2>/dev/null || echo "No se puede reiniciar Docker daemon"
        sleep 5

    - name: Crear directorios para scraper
      run: |
        echo "ğŸ“ Creando directorios necesarios..."
        cd modern-shopp
        mkdir -p public/products
        mkdir -p scripts/logs
        mkdir -p scripts/data
        chmod 777 public/products scripts/logs scripts/data
        echo "âœ… Directorios creados"

    - name: Construir y desplegar aplicaciÃ³n
      run: |
        echo "ğŸ—ï¸ Iniciando construcciÃ³n con soporte para Puppeteer..."
        cd modern-shopp
        
        echo "ğŸ“¥ Descargando imÃ¡genes base..."
        docker pull postgres:15-alpine
        
        echo "ğŸ”¨ Construyendo aplicaciÃ³n con Chromium..."
        for attempt in 1 2 3; do
          echo "Intento $attempt de construcciÃ³n..."
          if docker-compose -f docker-compose.prod.yml build --no-cache --pull; then
            echo "âœ… ConstrucciÃ³n exitosa"
            break
          else
            echo "âŒ FallÃ³ intento $attempt"
            if [ $attempt -eq 3 ]; then
              echo "ğŸ’¥ FallÃ³ despuÃ©s de 3 intentos"
              exit 1
            fi
            sleep 10
          fi
        done

    - name: Levantar servicios
      run: |
        echo "ğŸš€ Levantando servicios..."
        cd modern-shopp
        docker-compose -f docker-compose.prod.yml up -d
        
        echo "â³ Esperando que los servicios estÃ©n listos..."
        sleep 15

    - name: Ejecutar migraciones
      run: |
        echo "ğŸ—„ï¸ Ejecutando migraciones de Prisma..."
        cd modern-shopp
        docker-compose -f docker-compose.prod.yml exec -T nextjs npx prisma migrate deploy || true
        docker-compose -f docker-compose.prod.yml exec -T nextjs npx prisma generate || true

    - name: Verificar salud de la aplicaciÃ³n
      run: |
        echo "ğŸ¥ Verificando salud de la aplicaciÃ³n..."
        
        echo "ğŸ“Š Estado de contenedores:"
        docker ps
        
        echo "ğŸ” Logs de la aplicaciÃ³n:"
        docker logs ecommerce_app_prod --tail 50 || true
        
        echo "ğŸŒ Probando endpoint local..."
        for i in {1..10}; do
          if curl -s -f http://localhost:3000 > /dev/null; then
            echo "âœ… AplicaciÃ³n responde correctamente"
            exit 0
          fi
          echo "â³ Intento $i/10 - Esperando..."
          sleep 5
        done
        
        echo "âš ï¸ La aplicaciÃ³n no responde en localhost:3000"

    - name: Test scraper (dry-run)
      continue-on-error: true
      run: |
        echo "ğŸ§ª Probando scraper en modo dry-run..."
        cd modern-shopp
        
        echo "Esperando que el contenedor estÃ© completamente listo..."
        sleep 10
        
        echo "Ejecutando scraper de prueba (1 pÃ¡gina)..."
        docker exec -e MAX_PAGES=1 ecommerce_app_prod node scripts/scraper-main.js --dry-run || true
        
        echo "ğŸ“‹ Verificando archivos generados..."
        docker exec ecommerce_app_prod ls -lh scripts/data/ 2>/dev/null || echo "No se generaron archivos"
        docker exec ecommerce_app_prod ls -lh scripts/logs/ 2>/dev/null || echo "No se generaron logs"

    - name: Resultado del despliegue
      if: always()
      run: |
        echo "ğŸ“Š RESUMEN DEL DESPLIEGUE"
        echo "========================"
        echo "Rama: feature/scraper"
        echo "ğŸ³ Estado de Docker:"
        docker ps
        echo ""
        echo "ğŸ“ Ãšltimos logs:"
        docker logs ecommerce_app_prod --tail 30 || true
        echo ""
        echo "ğŸ“ Ãšltimos logs:"
        docker logs ecommerce_app --tail 30 || true
