name: Deploy Scraper Branch

on:
  push:
    branches: [ feature/scraper ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-and-deploy:
    name: Test & Deploy Scraper
    runs-on: self-hosted
    timeout-minutes: 30
    
    env:
      POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
      SECRET: ${{ secrets.SECRET }}
      MERCADOPAGO_ACCESS_TOKEN: ${{ secrets.MERCADOPAGO_ACCESS_TOKEN }}
      DROPPERS_EMAIL: ${{ secrets.DROPPERS_EMAIL }}
      DROPPERS_PASSWORD: ${{ secrets.DROPPERS_PASSWORD }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Verificar t√∫nel Cloudflare
      run: |
        echo "üîç Verificando t√∫nel Cloudflare..."
        
        if pgrep -f "cloudflared tunnel" > /dev/null; then
          echo "‚úÖ Proceso cloudflared est√° ejecut√°ndose"
        else
          echo "‚ö†Ô∏è No se encontr√≥ proceso cloudflared activo"
        fi
        
        if curl -s --max-time 15 -I https://ecomerce.noaservice.org | grep -q "200\|301\|302"; then
          echo "‚úÖ Dominio responde correctamente"
        else
          echo "‚ö†Ô∏è El dominio no responde, pero continuamos el despliegue"
        fi

    - name: Crear archivo .env.production
      run: |
        echo "üìù Creando .env.production..."
        cd modern-shopp
        
        cat > .env.production << EOF
        NODE_ENV=production
        DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD:-postgres}@postgres:5432/ecommerce
        NEXTAUTH_URL=https://ecomerce.noaservice.org
        NEXTAUTH_SECRET=${NEXTAUTH_SECRET:-MISECRETO}
        SECRET=${SECRET:-MISECRETO}
        MERCADOPAGO_ACCESS_TOKEN=${MERCADOPAGO_ACCESS_TOKEN}
        NEXT_PUBLIC_URL=https://ecomerce.noaservice.org
        POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
        PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser
        DROPPERS_EMAIL=${DROPPERS_EMAIL}
        DROPPERS_PASSWORD=${DROPPERS_PASSWORD}
        MAX_PAGES=2
        HEADLESS=true
        EOF
        
        echo "‚úÖ Archivo .env.production creado"

    - name: Parar servicios existentes
      run: |
        echo "‚èπÔ∏è Parando contenedores existentes..."
        cd modern-shopp
        docker-compose -f docker-compose.prod.yml down 2>/dev/null || true
        
        echo "üßπ Limpiando Docker..."
        docker system prune -af --volumes
        docker builder prune -af
        docker image prune -af
        
        echo "üîÑ Reiniciando Docker daemon..."
        sudo systemctl restart docker 2>/dev/null || echo "No se puede reiniciar Docker daemon"
        sleep 5

    - name: Crear directorios para scraper
      run: |
        echo "üìÅ Creando directorios necesarios..."
        cd modern-shopp
        mkdir -p public/products
        mkdir -p scripts/logs
        mkdir -p scripts/data
        chmod 777 public/products scripts/logs scripts/data
        echo "‚úÖ Directorios creados"

    - name: Construir y desplegar aplicaci√≥n
      run: |
        echo "üèóÔ∏è Iniciando construcci√≥n con soporte para Puppeteer..."
        cd modern-shopp
        
        echo "üì• Descargando im√°genes base..."
        docker pull postgres:15-alpine
        
        echo "üî® Construyendo aplicaci√≥n con Chromium..."
        for attempt in 1 2 3; do
          echo "Intento $attempt de construcci√≥n..."
          if docker-compose -f docker-compose.prod.yml build --no-cache --pull; then
            echo "‚úÖ Construcci√≥n exitosa"
            break
          else
            echo "‚ùå Fall√≥ intento $attempt"
            if [ $attempt -eq 3 ]; then
              echo "üí• Fall√≥ despu√©s de 3 intentos"
              exit 1
            fi
            sleep 10
          fi
        done

    - name: Levantar servicios
      run: |
        echo "üöÄ Levantando servicios..."
        cd modern-shopp
        docker-compose -f docker-compose.prod.yml up -d
        
        echo "‚è≥ Esperando que los servicios est√©n listos..."
        sleep 15

    - name: Ejecutar migraciones
      run: |
        echo "üóÑÔ∏è Ejecutando migraciones de Prisma..."
        cd modern-shopp
        docker-compose -f docker-compose.prod.yml exec -T nextjs npx prisma migrate deploy || true
        docker-compose -f docker-compose.prod.yml exec -T nextjs npx prisma generate || true

    - name: Verificar salud de la aplicaci√≥n
      run: |
        echo "üè• Verificando salud de la aplicaci√≥n..."
        
        echo "üìä Estado de contenedores:"
        docker ps
        
        echo "üîç Logs de la aplicaci√≥n:"
        docker logs ecommerce_app --tail 50
        
        echo "üåê Probando endpoint local..."
        for i in {1..10}; do
          if curl -s -f http://localhost:3000 > /dev/null; then
            echo "‚úÖ Aplicaci√≥n responde correctamente"
            exit 0
          fi
          echo "‚è≥ Intento $i/10 - Esperando..."
          sleep 5
        done
        
        echo "‚ö†Ô∏è La aplicaci√≥n no responde en localhost:3000"

    - name: Test scraper (dry-run)
      continue-on-error: true
      run: |
        echo "üß™ Probando scraper en modo dry-run..."
        cd modern-shopp
        
        echo "Ejecutando scraper de prueba (1 p√°gina)..."
        docker-compose -f docker-compose.prod.yml exec -T -e MAX_PAGES=1 nextjs node scripts/scraper-main.js --dry-run || true
        
        echo "üìã Verificando archivos generados..."
        docker-compose -f docker-compose.prod.yml exec -T nextjs ls -lh scripts/data/ || echo "No se generaron archivos"
        docker-compose -f docker-compose.prod.yml exec -T nextjs ls -lh scripts/logs/ || echo "No se generaron logs"

    - name: Resultado del despliegue
      if: always()
      run: |
        echo "üìä RESUMEN DEL DESPLIEGUE"
        echo "========================"
        echo "Rama: feature/scraper"
        echo "Commit: ${{ github.sha }}"
        echo "Actor: ${{ github.actor }}"
        echo ""
        echo "üê≥ Estado de Docker:"
        docker ps
        echo ""
        echo "üìù √öltimos logs:"
        docker logs ecommerce_app --tail 30 || true
