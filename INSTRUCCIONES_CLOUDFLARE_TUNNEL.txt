===============================================================================
üöÄ GU√çA COMPLETA: C√ìMO EXPONER APLICACIONES DOCKER A TRAV√âS DE CLOUDFLARE TUNNEL
===============================================================================

üìã PREREQUISITOS:
- Cloudflare Tunnel ya configurado y funcionando
- T√∫nel ID: 02bf07cb-daba-4f0f-82cc-ca7ba537c43b
- T√∫nel Name: ecommerce-nextshop
- Aplicaci√≥n actual: https://ecomerce.noaservice.org

===============================================================================
üìã PASO 1: DECIDIR LA ESTRUCTURA DE DOMINIOS
===============================================================================

OPCI√ìN A - SUBDOMINIOS (Recomendado):
‚úÖ ecomerce.noaservice.org ‚Üí Tienda actual
‚úÖ app2.noaservice.org ‚Üí Nueva aplicaci√≥n
‚úÖ api.noaservice.org ‚Üí API
‚úÖ admin.noaservice.org ‚Üí Panel administrativo

OPCI√ìN B - RUTAS (PATHS):
‚úÖ ecomerce.noaservice.org/ ‚Üí Tienda actual
‚úÖ ecomerce.noaservice.org/app2/ ‚Üí Nueva aplicaci√≥n
‚úÖ ecomerce.noaservice.org/api/ ‚Üí API

OPCI√ìN C - PUERTOS DIFERENTES:
‚úÖ ecomerce.noaservice.org:8082 ‚Üí Nueva aplicaci√≥n

===============================================================================
üìã PASO 2A: CONFIGURACI√ìN CON SUBDOMINIOS
===============================================================================

1. CREAR DNS PARA NUEVO SUBDOMINIO:
   cloudflared tunnel route dns ecommerce-nextshop app2.noaservice.org
   cloudflared tunnel route dns ecommerce-nextshop api.noaservice.org

2. ACTUALIZAR CONFIGURACI√ìN DEL T√öNEL:
   sudo nano /root/.cloudflared/config.yml

   CONTENIDO DEL ARCHIVO:
   ----------------------------------------
   tunnel: 02bf07cb-daba-4f0f-82cc-ca7ba537c43b
   credentials-file: /root/.cloudflared/02bf07cb-daba-4f0f-82cc-ca7ba537c43b.json

   ingress:
     # E-commerce Next.js (aplicaci√≥n actual)
     - hostname: ecomerce.noaservice.org
       service: http://localhost:8081
     - hostname: www.ecomerce.noaservice.org
       service: http://localhost:8081
       
     # Nueva aplicaci√≥n en puerto 8082
     - hostname: app2.noaservice.org
       service: http://localhost:8082
       
     # API en puerto 8083
     - hostname: api.noaservice.org
       service: http://localhost:8083
       
     # Panel admin en puerto 8084
     - hostname: admin.noaservice.org
       service: http://localhost:8084
       
     # Ruta por defecto (SIEMPRE DEBE SER LA √öLTIMA)
     - service: http_status:404
   ----------------------------------------

===============================================================================
üìã PASO 2B: CONFIGURACI√ìN CON RUTAS (PATHS)
===============================================================================

CONFIGURACI√ìN ALTERNATIVA PARA config.yml:
----------------------------------------
tunnel: 02bf07cb-daba-4f0f-82cc-ca7ba537c43b
credentials-file: /root/.cloudflared/02bf07cb-daba-4f0f-82cc-ca7ba537c43b.json

ingress:
  # Nueva aplicaci√≥n en /app2
  - hostname: ecomerce.noaservice.org
    path: /app2/*
    service: http://localhost:8082
    
  # API en /api
  - hostname: ecomerce.noaservice.org
    path: /api/*
    service: http://localhost:8083
    
  # Admin en /admin
  - hostname: ecomerce.noaservice.org
    path: /admin/*
    service: http://localhost:8084
    
  # E-commerce (todo lo dem√°s)
  - hostname: ecomerce.noaservice.org
    service: http://localhost:8081
  - hostname: www.ecomerce.noaservice.org
    service: http://localhost:8081
    
  # Ruta por defecto
  - service: http_status:404
----------------------------------------

===============================================================================
üìã PASO 3: EJEMPLOS DE APLICACIONES DOCKER
===============================================================================

üîß EJEMPLO 1: APLICACI√ìN WEB SIMPLE (NGINX)

1. CREAR DIRECTORIO:
   mkdir -p /home/app2
   cd /home/app2

2. CREAR Dockerfile:
   cat > Dockerfile << 'EOF'
   FROM nginx:alpine
   COPY index.html /usr/share/nginx/html/index.html
   EXPOSE 80
   EOF

3. CREAR P√ÅGINA WEB:
   cat > index.html << 'EOF'
   <!DOCTYPE html>
   <html>
   <head>
       <title>Mi Segunda App</title>
       <style>
           body { font-family: Arial; margin: 50px; background: #f0f0f0; }
           .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; }
           h1 { color: #333; }
       </style>
   </head>
   <body>
       <div class="container">
           <h1>üöÄ ¬°Aplicaci√≥n 2 Funcionando!</h1>
           <p>Esta es mi segunda aplicaci√≥n expuesta a trav√©s de Cloudflare Tunnel.</p>
           <p><strong>Fecha:</strong> <span id="fecha"></span></p>
           <script>
               document.getElementById('fecha').innerText = new Date().toLocaleString();
           </script>
       </div>
   </body>
   </html>
   EOF

4. CREAR docker-compose.yml:
   cat > docker-compose.yml << 'EOF'
   version: '3.8'
   services:
     app2:
       build: .
       container_name: mi_app2
       restart: always
       ports:
         - "8082:80"
   EOF

5. LEVANTAR APLICACI√ìN:
   docker-compose up -d --build

üîß EJEMPLO 2: API NODE.JS

1. CREAR DIRECTORIO:
   mkdir -p /home/api-node
   cd /home/api-node

2. CREAR app.js:
   cat > app.js << 'EOF'
   const express = require('express');
   const app = express();
   
   app.use(express.json());
   
   // CORS para permitir requests desde cualquier origen
   app.use((req, res, next) => {
       res.header('Access-Control-Allow-Origin', '*');
       res.header('Access-Control-Allow-Headers', 'Content-Type');
       next();
   });
   
   // Ruta principal
   app.get('/', (req, res) => {
       res.json({ 
           message: 'üöÄ API funcionando correctamente!', 
           timestamp: new Date(),
           version: '1.0.0'
       });
   });
   
   // Health check
   app.get('/health', (req, res) => {
       res.json({ status: 'OK', uptime: process.uptime() });
   });
   
   // Endpoint de ejemplo
   app.get('/users', (req, res) => {
       res.json([
           { id: 1, name: 'Juan P√©rez', email: 'juan@example.com' },
           { id: 2, name: 'Mar√≠a Garc√≠a', email: 'maria@example.com' }
       ]);
   });
   
   app.post('/users', (req, res) => {
       const { name, email } = req.body;
       res.json({ 
           message: 'Usuario creado', 
           user: { id: Date.now(), name, email }
       });
   });
   
   const PORT = 3000;
   app.listen(PORT, '0.0.0.0', () => {
       console.log(`üöÄ API ejecut√°ndose en puerto ${PORT}`);
   });
   EOF

3. CREAR package.json:
   cat > package.json << 'EOF'
   {
     "name": "mi-api",
     "version": "1.0.0",
     "description": "API de ejemplo",
     "main": "app.js",
     "scripts": {
       "start": "node app.js"
     },
     "dependencies": {
       "express": "^4.18.2"
     }
   }
   EOF

4. CREAR docker-compose.yml:
   cat > docker-compose.yml << 'EOF'
   version: '3.8'
   services:
     api:
       image: node:18-alpine
       container_name: mi_api
       working_dir: /app
       command: sh -c "npm install && npm start"
       volumes:
         - .:/app
       ports:
         - "8083:3000"
       restart: always
   EOF

5. LEVANTAR API:
   docker-compose up -d

üîß EJEMPLO 3: APLICACI√ìN PYTHON FLASK

1. CREAR DIRECTORIO:
   mkdir -p /home/flask-app
   cd /home/flask-app

2. CREAR app.py:
   cat > app.py << 'EOF'
   from flask import Flask, jsonify, render_template_string
   import datetime
   
   app = Flask(__name__)
   
   HTML_TEMPLATE = '''
   <!DOCTYPE html>
   <html>
   <head>
       <title>Flask App</title>
       <style>
           body { font-family: Arial; margin: 50px; background: #e3f2fd; }
           .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
           h1 { color: #1976d2; }
           .api-info { background: #f5f5f5; padding: 15px; border-radius: 5px; margin: 20px 0; }
       </style>
   </head>
   <body>
       <div class="container">
           <h1>üêç Flask Application</h1>
           <p><strong>Estado:</strong> ‚úÖ Funcionando correctamente</p>
           <p><strong>Timestamp:</strong> {{ timestamp }}</p>
           <div class="api-info">
               <h3>üöÄ Endpoints disponibles:</h3>
               <ul>
                   <li><strong>GET /</strong> - Esta p√°gina</li>
                   <li><strong>GET /api/status</strong> - Estado de la API</li>
                   <li><strong>GET /api/time</strong> - Hora actual</li>
               </ul>
           </div>
       </div>
   </body>
   </html>
   '''
   
   @app.route('/')
   def home():
       return render_template_string(HTML_TEMPLATE, timestamp=datetime.datetime.now())
   
   @app.route('/api/status')
   def status():
       return jsonify({
           'status': 'OK',
           'message': 'Flask API funcionando',
           'timestamp': datetime.datetime.now().isoformat()
       })
   
   @app.route('/api/time')
   def get_time():
       return jsonify({
           'current_time': datetime.datetime.now().isoformat(),
           'timezone': 'UTC'
       })
   
   if __name__ == '__main__':
       app.run(host='0.0.0.0', port=5000, debug=True)
   EOF

3. CREAR requirements.txt:
   cat > requirements.txt << 'EOF'
   Flask==2.3.3
   EOF

4. CREAR docker-compose.yml:
   cat > docker-compose.yml << 'EOF'
   version: '3.8'
   services:
     flask-app:
       image: python:3.9-slim
       container_name: mi_flask_app
       working_dir: /app
       command: sh -c "pip install -r requirements.txt && python app.py"
       volumes:
         - .:/app
       ports:
         - "8084:5000"
       restart: always
   EOF

5. LEVANTAR APLICACI√ìN:
   docker-compose up -d

===============================================================================
üìã PASO 4: VERIFICAR APLICACIONES LOCALMENTE
===============================================================================

ANTES DE CONFIGURAR EL T√öNEL, VERIFICA QUE FUNCIONEN:

# Verificar aplicaci√≥n web (puerto 8082):
curl http://localhost:8082

# Verificar API Node.js (puerto 8083):
curl http://localhost:8083
curl http://localhost:8083/health
curl http://localhost:8083/users

# Verificar Flask app (puerto 8084):
curl http://localhost:8084
curl http://localhost:8084/api/status

===============================================================================
üìã PASO 5: REINICIAR EL T√öNEL CON NUEVA CONFIGURACI√ìN
===============================================================================

1. REINICIAR SERVICIO:
   sudo systemctl restart cloudflared

2. VERIFICAR LOGS:
   sudo journalctl -u cloudflared -f --no-pager -n 20

3. VERIFICAR ESTADO:
   sudo systemctl status cloudflared

===============================================================================
üìã PASO 6: PROBAR LAS APLICACIONES P√öBLICAS
===============================================================================

üåê CON SUBDOMINIOS:
curl https://ecomerce.noaservice.org     # Tienda original
curl https://app2.noaservice.org         # Nueva aplicaci√≥n web
curl https://api.noaservice.org          # API Node.js
curl https://admin.noaservice.org        # Flask app

üåê CON RUTAS (PATHS):
curl https://ecomerce.noaservice.org/
curl https://ecomerce.noaservice.org/app2/
curl https://ecomerce.noaservice.org/api/
curl https://ecomerce.noaservice.org/admin/

===============================================================================
üìã COMANDOS √öTILES PARA GESTI√ìN
===============================================================================

üîß GESTI√ìN DEL T√öNEL:
# Ver logs del t√∫nel:
sudo journalctl -u cloudflared -f

# Reiniciar t√∫nel:
sudo systemctl restart cloudflared

# Parar t√∫nel:
sudo systemctl stop cloudflared

# Estado del t√∫nel:
sudo systemctl status cloudflared

üîß GESTI√ìN DE CONTENEDORES:
# Ver todos los contenedores:
docker ps -a

# Ver logs de una aplicaci√≥n espec√≠fica:
docker logs mi_app2 -f
docker logs mi_api -f
docker logs mi_flask_app -f

# Reiniciar una aplicaci√≥n:
docker restart mi_app2

# Parar todas las aplicaciones:
docker stop $(docker ps -q)

üîß INFORMACI√ìN DEL T√öNEL:
# Ver t√∫neles disponibles:
cloudflared tunnel list

# Ver informaci√≥n espec√≠fica:
cloudflared tunnel info ecommerce-nextshop

# Ver configuraci√≥n actual:
cat /root/.cloudflared/config.yml

===============================================================================
üìã SOLUCI√ìN DE PROBLEMAS COMUNES
===============================================================================

üö® PROBLEMA: El t√∫nel no encuentra las aplicaciones
SOLUCI√ìN: Verificar que las aplicaciones est√©n ejecut√°ndose en localhost con los puertos correctos

üö® PROBLEMA: Error 502 Bad Gateway
SOLUCI√ìN: 
- Verificar que la aplicaci√≥n est√© corriendo: curl http://localhost:PUERTO
- Verificar logs del t√∫nel: sudo journalctl -u cloudflared -f

üö® PROBLEMA: Aplicaci√≥n no responde
SOLUCI√ìN:
- Verificar puertos: netstat -tlnp | grep :PUERTO
- Verificar logs de Docker: docker logs NOMBRE_CONTENEDOR

üö® PROBLEMA: DNS no resuelve
SOLUCI√ìN:
- Verificar que se cre√≥ el DNS: nslookup SUBDOMINIO.noaservice.org
- Esperar propagaci√≥n DNS (puede tomar hasta 5 minutos)

===============================================================================
üìã EJEMPLO COMPLETO DE CONFIGURACI√ìN FINAL
===============================================================================

ARCHIVO: /root/.cloudflared/config.yml
----------------------------------------
tunnel: 02bf07cb-daba-4f0f-82cc-ca7ba537c43b
credentials-file: /root/.cloudflared/02bf07cb-daba-4f0f-82cc-ca7ba537c43b.json

ingress:
  # E-commerce principal
  - hostname: ecomerce.noaservice.org
    service: http://localhost:8081
  - hostname: www.ecomerce.noaservice.org
    service: http://localhost:8081
    
  # Aplicaci√≥n web adicional
  - hostname: app2.noaservice.org
    service: http://localhost:8082
    
  # API Node.js
  - hostname: api.noaservice.org
    service: http://localhost:8083
    
  # Panel administrativo Flask
  - hostname: admin.noaservice.org
    service: http://localhost:8084
    
  # Ruta por defecto
  - service: http_status:404
----------------------------------------

APLICACIONES RESULTANTES:
‚úÖ https://ecomerce.noaservice.org ‚Üí E-commerce Next.js
‚úÖ https://app2.noaservice.org ‚Üí Aplicaci√≥n web Nginx  
‚úÖ https://api.noaservice.org ‚Üí API Node.js
‚úÖ https://admin.noaservice.org ‚Üí Panel Flask

===============================================================================
üìã NOTAS IMPORTANTES
===============================================================================

‚ö†Ô∏è  SIEMPRE verificar aplicaciones localmente antes de exponerlas
‚ö†Ô∏è  El orden de las reglas en ingress importa (m√°s espec√≠ficas primero)
‚ö†Ô∏è  La regla por defecto (service: http_status:404) debe ser la √∫ltima
‚ö†Ô∏è  Los puertos deben estar libres y no en uso por otras aplicaciones
‚ö†Ô∏è  Reiniciar el t√∫nel despu√©s de cambios en config.yml
‚ö†Ô∏è  Verificar logs si algo no funciona

===============================================================================
üéâ ¬°LISTO! AHORA PUEDES EXPONER M√öLTIPLES APLICACIONES DOCKER üéâ
===============================================================================

Creado: 10 de noviembre de 2025
T√∫nel ID: 02bf07cb-daba-4f0f-82cc-ca7ba537c43b
Configuraci√≥n: ecomerce.noaservice.org funcionando